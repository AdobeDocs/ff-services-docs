"use strict";(self.webpackChunkdev_site_documentation_template=self.webpackChunkdev_site_documentation_template||[]).push([[111],{64677:function(e,n,a){a.r(n),a.d(n,{_frontmatter:function(){return l},default:function(){return c}});var t=a(58168),s=a(80045),o=(a(88763),a(15680)),i=a(83407);const r=["components"],l={},d={_frontmatter:l},p=i.A;function c(e){let{components:n}=e,a=(0,s.A)(e,r);return(0,o.mdx)(p,(0,t.A)({},d,a,{components:n,mdxType:"MDXLayout"}),(0,o.mdx)("h1",{id:"using-the-asynchronous-adobe-firefly-apis"},"Using the Asynchronous Adobe Firefly APIs"),(0,o.mdx)("p",null,"With our launch of new asynchronous APIs, you can manage your Firefly requests and responses more efficiently."),(0,o.mdx)("h2",{id:"introduction"},"Introduction"),(0,o.mdx)("p",null,"Our original Firefly APIs operated in a synchronous fashion. This meant that you could call the API with a given text prompt and generate an image, however Firefly platform delayed returning the response until it generated your assets. If you're not already familiar with our standard, synchronous APIs, see our ",(0,o.mdx)("a",{parentName:"p",href:"../index.md"},"Quickstart Guide"),"."),(0,o.mdx)("p",null,(0,o.mdx)("span",{parentName:"p",className:"gatsby-resp-image-wrapper",style:{position:"relative",display:"block",marginLeft:"auto",marginRight:"auto",maxWidth:"672px"}},"\n      ",(0,o.mdx)("span",{parentName:"span",className:"gatsby-resp-image-background-image",style:{paddingBottom:"57.1875%",position:"relative",bottom:"0",left:"0",display:"block",transition:"opacity 0.5s 0.5s",pointerEvents:"none"}}),"\n  ",(0,o.mdx)("picture",{parentName:"span"},"\n          ",(0,o.mdx)("source",{parentName:"picture",srcSet:["/ff-services-docs/static/98354dcc6dc2328b07b1a745f8114a5a/5530d/bearsdancingforest.webp 320w","/ff-services-docs/static/98354dcc6dc2328b07b1a745f8114a5a/0c8fb/bearsdancingforest.webp 640w","/ff-services-docs/static/98354dcc6dc2328b07b1a745f8114a5a/42a33/bearsdancingforest.webp 672w"],sizes:"(max-width: 672px) 100vw, 672px",type:"image/webp"}),"\n          ",(0,o.mdx)("source",{parentName:"picture",srcSet:["/ff-services-docs/static/98354dcc6dc2328b07b1a745f8114a5a/8980b/bearsdancingforest.jpg 320w","/ff-services-docs/static/98354dcc6dc2328b07b1a745f8114a5a/56d4e/bearsdancingforest.jpg 640w","/ff-services-docs/static/98354dcc6dc2328b07b1a745f8114a5a/a7b22/bearsdancingforest.jpg 672w"],sizes:"(max-width: 672px) 100vw, 672px",type:"image/jpeg"}),"\n          ",(0,o.mdx)("img",{parentName:"picture",className:"gatsby-resp-image-image",src:"/ff-services-docs/static/98354dcc6dc2328b07b1a745f8114a5a/a7b22/bearsdancingforest.jpg",alt:"bears in dresses dancing",title:"bears in dresses dancing",loading:"lazy",style:{width:"100%",height:"100%",margin:"0",verticalAlign:"middle",position:"absolute",opacity:"0",transition:"opacity 0.5s",color:"inherit",boxShadow:"inset 0px 0px 0px 400px none",top:"0",left:"0"}}),"\n        "),"\n    ")),(0,o.mdx)("p",null,"Currently, the async operations include:"),(0,o.mdx)("ul",null,(0,o.mdx)("li",{parentName:"ul"},(0,o.mdx)("a",{parentName:"li",href:"../api/image_generation/V3_Async/"},"Generate Image Async")),(0,o.mdx)("li",{parentName:"ul"},(0,o.mdx)("a",{parentName:"li",href:"../api/generative_expand/V3_Async/"},"Expand Image Async")),(0,o.mdx)("li",{parentName:"ul"},(0,o.mdx)("a",{parentName:"li",href:"../api/generative_fill/V3_Async/"},"Fill Image Async")),(0,o.mdx)("li",{parentName:"ul"},(0,o.mdx)("a",{parentName:"li",href:"../api/generate-object-composite/V3_Async/"},"Generate Object Composite Async")),(0,o.mdx)("li",{parentName:"ul"},(0,o.mdx)("a",{parentName:"li",href:"../api/generate-similar/V3_Async/"},"Generate Similar Images Async"))),(0,o.mdx)("h2",{id:"sequence-of-calls"},"Sequence of Calls"),(0,o.mdx)("p",null,"The workflow for each of these is the same:"),(0,o.mdx)("ul",null,(0,o.mdx)("li",{parentName:"ul"},"Make a request, and send any required and optional arguments."),(0,o.mdx)("li",{parentName:"ul"},"Firefly responds and returns a job ID that includes a URL. Use the ID and URL to check the status of your request or to cancel the job."),(0,o.mdx)("li",{parentName:"ul"},"Check on the job, with scheduled requests for a time reasonable time period. For example, check once every second and wait for a success or failure message."),(0,o.mdx)("li",{parentName:"ul"},"On success, Firefly sends you a result containing URLs."),(0,o.mdx)("li",{parentName:"ul"},"Retrieve your assets from the URL.")),(0,o.mdx)("h2",{id:"generating-images-with-the-async-api"},"Generating Images with the Async API"),(0,o.mdx)("p",null,"Start with this example that uses the asynchronous version of the text to image endpoint, see ",(0,o.mdx)("a",{parentName:"p",href:"../api/image_generation/V3_Async/"},"Generate Image Async API Reference"),". For now we won't show authentication which is the same as it is for synchronous calls."),(0,o.mdx)("p",null,"In terms of required and optional arguments, you have the same options that you do with the synchronous endpoint. At minimum, you should send a text prompt; beyond that, you can send optional arguments to help Firefly create the final result. This includes the content class as well as structure and style options. In fact, the only real change to the code for your request beyond what you already do for synchronous requests is to sent it to a different endpoint:"),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre",className:"language-js"},"let BASE = 'https://firefly-api.adobe.io';\n\nasync function asyncTextToImage(prompt, contentClass='photo', id, token) {\n\n    let body = {\n        prompt, \n        contentClass\n    }\n\n    let resp = await fetch(`${BASE}/v3/images/generate-async`, {\n        method:'POST',\n        headers: {\n            'x-api-key':id, \n            'Authorization':`Bearer ${token}`,\n            'Content-Type':'application/json'\n        }, \n        body: JSON.stringify(body)\n    });\n\n    return await resp.json();\n\n}\n")),(0,o.mdx)("p",null,"This simple ",(0,o.mdx)("inlineCode",{parentName:"p"},"Node.js")," wrapper calls the endpoint and helps you to pass a text prompt and a content class. As mentioned earlier, you have a whole set of other options you can change as well."),(0,o.mdx)("p",null,"The main difference now is the response. With the synchronous version, this method waited while Firefly generated your images. Now, on success, you get a rapid response that looks like this:"),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre",className:"language-json"},'{\n  "jobId": "urn:ff:jobs:eso851211:86ffe2ea-d765-4bd3-b2fd-568ca8fc36ac",\n  "statusUrl": "https://firefly-api.adobe.io/v3/status/urn:ff:jobs:eso851211:86ffe2ea-d765-4bd3-b2fd-568ca8fc36ac",\n  "cancelUrl": "https://firefly-api.adobe.io/v3/cancel/urn:ff:jobs:eso851211:86ffe2ea-d765-4bd3-b2fd-568ca8fc36ac"\n}\n')),(0,o.mdx)("p",null,"In your code, you can use ",(0,o.mdx)("inlineCode",{parentName:"p"},"statusUrl")," and ",(0,o.mdx)("inlineCode",{parentName:"p"},"cancelUrl")," to get the latest status of your request or to cancel the request. If you want, you can also use ",(0,o.mdx)("inlineCode",{parentName:"p"},"jobId")," for logging. Here's an example function that repeatedly polls ",(0,o.mdx)("inlineCode",{parentName:"p"},"statusUrl")," to see when Firefly completes the job:"),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre",className:"language-js"},"async function pollJob(jobUrl, id, token) {\n    let status = '';\n\n    while(status !== 'succeeded' && status !== 'failed') {\n\n        let resp = await fetch(jobUrl, {\n            headers: {\n                'Authorization':`Bearer ${token}`,\n                'x-api-key': id\n            }\n        });\n\n        let data = await resp.json();\n        status = data.status;\n\n        // delay is a utility to 'pause' for X ms\n        if (status !== 'succeeded' && status !== 'failed') await delay(1000);\n        if (status === 'succeeded') return data;\n    }\n\n    return status;\n\n}\n")),(0,o.mdx)("p",null,"While your job is still in progress, you get a result that looks like this:"),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre",className:"language-json"},'{ \n    "status": "running", \n    "jobId": "86ffe2ea-d765-4bd3-b2fd-568ca8fc36ac"\n}\n')),(0,o.mdx)("p",null,"After Firefly successfully generates your image, the final status looks similar to this response:"),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre",className:"language-json"},'{\n        "status": "succeeded",\n        "jobId": "urn:ff:jobs:eso851211:86ffe2ea-d765-4bd3-b2fd-568ca8fc36ac",\n        "result": {\n                "size": {\n                        "width": 2048,\n                        "height": 2048\n                },\n                "outputs": [\n                        {\n                                "seed": 2142812600,\n                                "image": {\n                                        "url": "https://pre-signed-firefly-prod.s3-accelerate.amazonaws.com/images/0c5c80a3-7189-4bd3-a52e-87b36e4fc47b12345"\n                                }\n                        }\n                ],\n                "contentClass": "art"\n        }\n}\n')),(0,o.mdx)("p",null,"Altogether, here's a complete script that takes a static text prompt, creates a request to Firefly, and checks the status of this request. When Firefly generates the image, this script saves the result to the file system. As a reminder, any utility functions below such as the one handling authentication are the same as when you make synchronous calls, and your code could implement this authentication differently."),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre",className:"language-js"},"import fs from 'fs';\nimport { Readable } from 'stream';\nimport { finished } from 'stream/promises';\n\nlet FIREFLY_SERVICES_CLIENT_ID = process.env.FIREFLY_SERVICES_CLIENT_ID;\nlet FIREFLY_SERVICES_CLIENT_SECRET = process.env.FIREFLY_SERVICES_CLIENT_SECRET;\n\nlet BASE = 'https://firefly-api.adobe.io';\n\nasync function getAccessToken(id, secret) {\n    const params = new URLSearchParams();\n\n    params.append('grant_type', 'client_credentials');\n    params.append('client_id', id);\n    params.append('client_secret', secret);\n    params.append('scope', 'openid,AdobeID,read_organizations,firefly_enterprise,firefly_api,ff_apis');\n    \n    let resp = await fetch('https://ims-na1.adobelogin.com/ims/token/v3', \n        { \n            method: 'POST', \n            body: params\n        }\n    );\n\n    let data = await resp.json();\n    return data.access_token;\n}\n\nasync function asyncTextToImage(prompt, contentClass='photo', id, token) {\n\n    let body = {\n        prompt, \n        contentClass\n    }\n\n    let resp = await fetch(`${BASE}/v3/images/generate-async`, {\n        method:'POST',\n        headers: {\n            'x-api-key':id, \n            'Authorization':`Bearer ${token}`,\n            'Content-Type':'application/json'\n        }, \n        body: JSON.stringify(body)\n    });\n\n    return await resp.json();\n\n}\n\nasync function delay(x) {\n    return new Promise(resolve => {\n        setTimeout(() => {\n            resolve();\n        }, x);\n    });\n}\n\nasync function pollJob(jobUrl, id, token) {\n    let status = '';\n\n    while(status !== 'succeeded' && status !== 'failed') {\n\n        let resp = await fetch(jobUrl, {\n            headers: {\n                'Authorization':`Bearer ${token}`,\n                'x-api-key': id\n            }\n        });\n\n        let data = await resp.json();\n        console.log(data);\n        status = data.status;\n\n        if (status !== 'succeeded' && status !== 'failed') await delay(1000);\n        if (status === 'succeeded') return data;\n    }\n\n    return status;\n\n}\n\nasync function downloadFile(url, filePath) {\n    let res = await fetch(url);\n    const body = Readable.fromWeb(res.body);\n    const download_write_stream = fs.createWriteStream(filePath);\n    return await finished(body.pipe(download_write_stream));\n}\n\nlet token = await getAccessToken(FIREFLY_SERVICES_CLIENT_ID, FIREFLY_SERVICES_CLIENT_SECRET);\n\nlet result = await asyncTextToImage('a cat living their best life, sleeping in a sunbeam', 'art', FIREFLY_SERVICES_CLIENT_ID, token);\nconsole.log(result);\n\nlet jobResult = await pollJob(result.statusUrl, FIREFLY_SERVICES_CLIENT_ID, token);\nconsole.log(JSON.stringify(jobResult, null, '\\t'));\n\nfor(let output of jobResult.result.outputs) {\n    let fileName = `./${output.seed}.jpg`;\n    await downloadFile(output.image.url, fileName);\n}\n")),(0,o.mdx)("h2",{id:"expanding-images-with-async-apis"},"Expanding Images with Async APIs"),(0,o.mdx)("p",null,"The asynchronous API are even more powerful; in this next example, we take a source image, upload it, and then use the ",(0,o.mdx)("a",{parentName:"p",href:"../api/generative_expand/V3_Async/"},"Expand Image Asynchronous API")," to resize it. Instead of doing one resize after another, we can kick off multiple jobs at once so we can resize an image much more efficiently."),(0,o.mdx)("p",null,"First, let's look at our wrapper function which uses a small subset of available parameters. In this case, our wrapper only needs the source image and your desired size:"),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre",className:"language-js"},"async function asyncExpandImage(source, size, id, token) {\n\n    let [ width, height ] = size.split('x');\n\n    let body = {\n        image: {\n            source: {\n                uploadId: source\n            }\n        },\n        size: {\n            width, height\n        }\n    }\n\n    let resp = await fetch(`${BASE}/v3/images/expand-async`, {\n        method:'POST',\n        headers: {\n            'x-api-key':id, \n            'Authorization':`Bearer ${token}`,\n            'Content-Type':'application/json'\n        }, \n        body: JSON.stringify(body)\n    });\n\n    return await resp.json();\n}\n")),(0,o.mdx)("p",null,"Now let's look at the code that uses this. We begin by authenticating and uploading a source image:"),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre",className:"language-js"},"let token = await getAccessToken(FIREFLY_SERVICES_CLIENT_ID, FIREFLY_SERVICES_CLIENT_SECRET);\n\nlet upload = await uploadImage('./source.jpg', 'image/jpeg', FIREFLY_SERVICES_CLIENT_ID, token);\nlet uploadedImage = upload.images[0].id;\n")),(0,o.mdx)("p",null,(0,o.mdx)("inlineCode",{parentName:"p"},"uploadImage")," wraps the ",(0,o.mdx)("a",{parentName:"p",href:"https://developer.adobe.com/firefly-services/docs/firefly-api/guides/api/upload_image/"},(0,o.mdx)("inlineCode",{parentName:"a"},"upload"))," method. Also note that as with the synchronous versions of the Firefly APIs, you can also work with signed URLs from our supported cloud storage providers."),(0,o.mdx)("p",null,"Now, let's define a set of desired sizes, kick off the jobs, and wait for them to complete:"),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre",className:"language-js"},"let sizes = ['2500x2500','3000x3000','3500x3500'];\n\nlet expandJobs = [];\nfor(let size of sizes) {\n    console.log(`Create job to expand our source to ${size}`);\n    expandJobs.push(asyncExpandImage(uploadedImage, size, FIREFLY_SERVICES_CLIENT_ID, token));\n}\n\nlet jobs = await Promise.all(expandJobs);\n")),(0,o.mdx)("p",null,"Typically you should have additional error checking in place. At this point, all three jobs for each of the three sizes have begun."),(0,o.mdx)("p",null,"Next we set up our polling and wait for them to complete:"),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre",className:"language-js"},"let expandResults = [];\njobs.forEach(j => {\n    expandResults.push(pollJob(j.statusUrl, FIREFLY_SERVICES_CLIENT_ID, token));\n});\nconsole.log('Waiting for the jobs to complete...');\n\nlet finalResults = await Promise.all(expandResults);\n")),(0,o.mdx)("p",null,"Once the jobs successfully complete, we download the results:"),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre",className:"language-js"},"console.log('All work done, now downloading.');\n\nfinalResults.forEach((r,i) => {\n    // we know we only have one result\n    downloadFile(r.result.outputs[0].image.url, `source_${sizes[i]}.jpg`);\n});\n")),(0,o.mdx)("p",null,"Here's the complete script for this example:"),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre",className:"language-js"},"import fs from 'fs';\nimport { Readable } from 'stream';\nimport { finished } from 'stream/promises';\n\nlet FIREFLY_SERVICES_CLIENT_ID = process.env.FIREFLY_SERVICES_CLIENT_ID;\nlet FIREFLY_SERVICES_CLIENT_SECRET = process.env.FIREFLY_SERVICES_CLIENT_SECRET;\n\nlet BASE = 'https://firefly-api.adobe.io';\n\nasync function getAccessToken(id, secret) {\n    const params = new URLSearchParams();\n\n    params.append('grant_type', 'client_credentials');\n    params.append('client_id', id);\n    params.append('client_secret', secret);\n    params.append('scope', 'openid,AdobeID,read_organizations,firefly_enterprise,firefly_api,ff_apis');\n    \n    let resp = await fetch('https://ims-na1.adobelogin.com/ims/token/v3', \n        { \n            method: 'POST', \n            body: params\n        }\n    );\n\n    let data = await resp.json();\n    return data.access_token;\n}\n\nasync function asyncExpandImage(source, size, id, token) {\n\n    let [ width, height ] = size.split('x');\n\n    let body = {\n        image: {\n            source: {\n                uploadId: source\n            }\n        },\n        size: {\n            width, height\n        }\n    }\n\n    let resp = await fetch(`${BASE}/v3/images/expand-async`, {\n        method:'POST',\n        headers: {\n            'x-api-key':id, \n            'Authorization':`Bearer ${token}`,\n            'Content-Type':'application/json'\n        }, \n        body: JSON.stringify(body)\n    });\n\n    return await resp.json();\n}\n\nasync function delay(x) {\n    return new Promise(resolve => {\n        setTimeout(() => {\n            resolve();\n        }, x);\n    });\n}\n\nasync function pollJob(jobUrl, id, token) {\n    let status = '';\n\n    while(status !== 'succeeded' && status !== 'failed') {\n\n        let resp = await fetch(jobUrl, {\n            headers: {\n                'Authorization':`Bearer ${token}`,\n                'x-api-key': id\n            }\n        });\n\n        let data = await resp.json();\n        status = data.status;\n\n        if (status !== 'succeeded' && status !== 'failed') await delay(1000);\n        if (status === 'succeeded') return data;\n    }\n\n    // only returns for fails now, meh\n    return status;\n\n}\n\nasync function uploadImage(filePath, fileType, id, token) {\n\n    let stream = fs.createReadStream(filePath);\n    let stats = fs.statSync(filePath);\n    let fileSizeInBytes = stats.size;\n\n    let upload = await fetch(`${BASE}/v2/storage/image`, {\n        method:'POST', \n        headers: {\n            'Authorization':`Bearer ${token}`, \n            'X-API-Key':id, \n            'Content-Type':fileType, \n            'Content-Length':fileSizeInBytes\n        }, \n        duplex:'half', \n        body:stream\n    });\n\n    return await upload.json();\n}\n\nasync function downloadFile(url, filePath) {\n    let res = await fetch(url);\n    const body = Readable.fromWeb(res.body);\n    const download_write_stream = fs.createWriteStream(filePath);\n    return await finished(body.pipe(download_write_stream));\n}\n\nlet token = await getAccessToken(FIREFLY_SERVICES_CLIENT_ID, FIREFLY_SERVICES_CLIENT_SECRET);\n\nlet upload = await uploadImage('./source.jpg', 'image/jpeg', FIREFLY_SERVICES_CLIENT_ID, token);\nlet uploadedImage = upload.images[0].id;\n\nlet sizes = ['2500x2500','3000x3000','3500x3500'];\n\nlet expandJobs = [];\nfor(let size of sizes) {\n    console.log(`Create job to expand our source to ${size}`);\n    expandJobs.push(asyncExpandImage(uploadedImage, size, FIREFLY_SERVICES_CLIENT_ID, token));\n}\n\nlet jobs = await Promise.all(expandJobs);\n\nlet expandResults = [];\njobs.forEach(j => {\n    expandResults.push(pollJob(j.statusUrl, FIREFLY_SERVICES_CLIENT_ID, token));\n});\nconsole.log('Waiting for the jobs to complete...');\n\nlet finalResults = await Promise.all(expandResults);\nconsole.log('All work done, now downloading.');\n\nfinalResults.forEach((r,i) => {\n    // we know we only have one result\n    downloadFile(r.result.outputs[0].image.url, `source_${sizes[i]}.jpg`);\n});\n")))}c.isMDXComponent=!0}}]);
//# sourceMappingURL=component---src-pages-firefly-api-guides-how-tos-using-async-apis-md-ae78de8de0554724697f.js.map